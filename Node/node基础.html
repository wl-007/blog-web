<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>全局对象 global | web</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="web文档">
    
    <link rel="preload" href="/blog-web/assets/css/0.styles.d72a2d24.css" as="style"><link rel="preload" href="/blog-web/assets/js/app.eabe3d57.js" as="script"><link rel="preload" href="/blog-web/assets/js/2.7f8e9262.js" as="script"><link rel="preload" href="/blog-web/assets/js/1.94089482.js" as="script"><link rel="preload" href="/blog-web/assets/js/24.92e24571.js" as="script"><link rel="prefetch" href="/blog-web/assets/js/10.0116ace5.js"><link rel="prefetch" href="/blog-web/assets/js/11.ff26e9e2.js"><link rel="prefetch" href="/blog-web/assets/js/12.dc0807d4.js"><link rel="prefetch" href="/blog-web/assets/js/13.4bd4910c.js"><link rel="prefetch" href="/blog-web/assets/js/14.96647d70.js"><link rel="prefetch" href="/blog-web/assets/js/15.fd76ba49.js"><link rel="prefetch" href="/blog-web/assets/js/16.c9f16319.js"><link rel="prefetch" href="/blog-web/assets/js/17.9cdfe3f1.js"><link rel="prefetch" href="/blog-web/assets/js/18.996486a4.js"><link rel="prefetch" href="/blog-web/assets/js/19.a447299e.js"><link rel="prefetch" href="/blog-web/assets/js/20.3c2a7b81.js"><link rel="prefetch" href="/blog-web/assets/js/21.680c4dde.js"><link rel="prefetch" href="/blog-web/assets/js/22.5d6ee25d.js"><link rel="prefetch" href="/blog-web/assets/js/23.d4283d2b.js"><link rel="prefetch" href="/blog-web/assets/js/25.a1e58209.js"><link rel="prefetch" href="/blog-web/assets/js/26.a1fe98cb.js"><link rel="prefetch" href="/blog-web/assets/js/27.50165141.js"><link rel="prefetch" href="/blog-web/assets/js/28.0bf1ebb4.js"><link rel="prefetch" href="/blog-web/assets/js/29.c751000f.js"><link rel="prefetch" href="/blog-web/assets/js/3.12023c25.js"><link rel="prefetch" href="/blog-web/assets/js/30.0bf5a263.js"><link rel="prefetch" href="/blog-web/assets/js/31.e566a84a.js"><link rel="prefetch" href="/blog-web/assets/js/32.8b7431c9.js"><link rel="prefetch" href="/blog-web/assets/js/4.e35e8262.js"><link rel="prefetch" href="/blog-web/assets/js/5.d3711a55.js"><link rel="prefetch" href="/blog-web/assets/js/6.cd437045.js"><link rel="prefetch" href="/blog-web/assets/js/7.8850a23c.js"><link rel="prefetch" href="/blog-web/assets/js/vendors~docsearch.3d49b2ab.js">
    <link rel="stylesheet" href="/blog-web/assets/css/0.styles.d72a2d24.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog-web/" class="home-link router-link-active"><!----> <span class="site-name">web</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><span class="title">基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础" class="mobile-dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          CSS
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/css/css基础.html" class="nav-link">
  CSS基础
</a></li><li class="dropdown-subitem"><a href="/blog-web/css/css进阶.html" class="nav-link">
  CSS进阶
</a></li></ul></li><li class="dropdown-item"><h4>
          JS
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/JS/JS基础.html" class="nav-link">
  JS基础
</a></li></ul></li><li class="dropdown-item"><h4>
          Vue
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/Vue/vue2.html" class="nav-link">
  vue2
</a></li><li class="dropdown-subitem"><a href="/blog-web/Vue/vue3.html" class="nav-link">
  vue3
</a></li></ul></li><li class="dropdown-item"><h4>
          React
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/React/react.html" class="nav-link">
  React
</a></li></ul></li><li class="dropdown-item"><h4>
          Node
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/Node/node基础.html" class="nav-link">
  Node
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          TS
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/TS/ts.html" class="nav-link">
  ts
</a></li></ul></li><li class="dropdown-item"><h4>
          UniApp
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/UniApp/UniApp.html" class="nav-link">
  UniApp
</a></li><li class="dropdown-subitem"><a href="/blog-web/UniApp/工具Code.html" class="nav-link">
  工具Code
</a></li></ul></li></ul></div></div> <a href="https://github.com/wl-007//blog-web/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="基础" class="dropdown-title"><span class="title">基础</span> <span class="arrow down"></span></button> <button type="button" aria-label="基础" class="mobile-dropdown-title"><span class="title">基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          CSS
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/css/css基础.html" class="nav-link">
  CSS基础
</a></li><li class="dropdown-subitem"><a href="/blog-web/css/css进阶.html" class="nav-link">
  CSS进阶
</a></li></ul></li><li class="dropdown-item"><h4>
          JS
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/JS/JS基础.html" class="nav-link">
  JS基础
</a></li></ul></li><li class="dropdown-item"><h4>
          Vue
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/Vue/vue2.html" class="nav-link">
  vue2
</a></li><li class="dropdown-subitem"><a href="/blog-web/Vue/vue3.html" class="nav-link">
  vue3
</a></li></ul></li><li class="dropdown-item"><h4>
          React
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/React/react.html" class="nav-link">
  React
</a></li></ul></li><li class="dropdown-item"><h4>
          Node
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/Node/node基础.html" class="nav-link">
  Node
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><span class="title">其他</span> <span class="arrow down"></span></button> <button type="button" aria-label="其他" class="mobile-dropdown-title"><span class="title">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          TS
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/TS/ts.html" class="nav-link">
  ts
</a></li></ul></li><li class="dropdown-item"><h4>
          UniApp
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/blog-web/UniApp/UniApp.html" class="nav-link">
  UniApp
</a></li><li class="dropdown-subitem"><a href="/blog-web/UniApp/工具Code.html" class="nav-link">
  工具Code
</a></li></ul></li></ul></div></div> <a href="https://github.com/wl-007//blog-web/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>JS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Node</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog-web/Node/node基础.html" class="active sidebar-link">Node</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#常用全局对象" class="sidebar-link">常用全局对象</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#events-事件驱动" class="sidebar-link">events 事件驱动</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#文件系统-fs" class="sidebar-link">文件系统 fs</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#stream-流" class="sidebar-link">Stream 流</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#http" class="sidebar-link">http</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#express-安装" class="sidebar-link">express  安装</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#express-改造项目" class="sidebar-link">express 改造项目</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#中间件" class="sidebar-link">中间件</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#路由" class="sidebar-link">路由</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#解析请求参数" class="sidebar-link">解析请求参数</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#静态资源服务器" class="sidebar-link">静态资源服务器</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#mongodb-2" class="sidebar-link">Mongodb</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#mongooes插件" class="sidebar-link">mongooes插件</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#代码片段" class="sidebar-link">代码片段</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#配置路由" class="sidebar-link">配置路由</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#filescontroller-js" class="sidebar-link">FilesController.js</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#工具库" class="sidebar-link">工具库</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#前端网络请求封装" class="sidebar-link">前端网络请求封装</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#前端使用栗子" class="sidebar-link">前端使用栗子</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#md5加密" class="sidebar-link">MD5加密</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#jwt本身也是一种规范" class="sidebar-link">JWT本身也是一种规范，</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#后端生产token" class="sidebar-link">后端生产token</a></li><li class="sidebar-sub-header"><a href="/blog-web/Node/node基础.html#使用公钥和私钥作为密钥" class="sidebar-link">使用公钥和私钥作为密钥：</a></li></ul></li></ul></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="全局对象-global"><a href="#全局对象-global" class="header-anchor">#</a> 全局对象 global</h1> <h2 id="常用全局对象"><a href="#常用全局对象" class="header-anchor">#</a> 常用全局对象</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token literal-property property">globalThis</span>  <span class="token operator">:</span> 浏览器nodejs统一全局对象  浏览器的window，node的global
<span class="token literal-property property">__dirname</span> <span class="token operator">:</span>当前模块的目录名
<span class="token literal-property property">——filename</span><span class="token operator">:</span> 当前模块的文件名  <span class="token comment">// 打印: /Users/mjr   路径加文件名</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span>callback<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// 在本轮 Node.js 事件循环结束时调用的函数</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span>callback<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">//在 JavaScript 堆栈上的当前操作运行完成之后，且在允许事件循环继续之前，此队列将被完全排空。</span>
</code></pre></div><h1 id="后端模块化开发"><a href="#后端模块化开发" class="header-anchor">#</a> 后端模块化开发</h1> <p>后端模块化：commonJs规范</p> <ul><li>暴露  module.exports在一个js中只能暴露一条数据，那如果需要暴露多个数据可以放在一个对象中</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">100</span>
<span class="token punctuation">}</span>
<span class="token comment">// 变量a被暴露了</span>
<span class="token comment">// module.exports = a</span>
<span class="token comment">// module.exports = fn</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">,</span>
    fn
<span class="token punctuation">}</span>
</code></pre></div><ul><li>引入</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 这个地方的{}是在 结构赋值</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span>fn<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="常用模块"><a href="#常用模块" class="header-anchor">#</a> 常用模块</h1> <h2 id="events-事件驱动"><a href="#events-事件驱动" class="header-anchor">#</a> events 事件驱动</h2> <p>events 模块只提供了一个对象： events.EventEmitter。EventEmitter 的核心就 是事件发射与事件监听器功能的封装。</p> <p>EventEmitter常用的API。</p> <ul><li>EventEmitter.on(event, listener) 为指定事件注册一个监听器，接受一个字 符串 event 和一个回调函数 listener。</li> <li>EventEmitter.emit(event, [arg1], [arg2], [...]) 发射 event 事件，传 递若干可选参数到事件监听器的参数表。</li> <li>EventEmitter.once(event, listener) 为指定事件注册一个单次监听器，即 监听器最多只会触发一次，触发后立刻解除该监听器。</li> <li>EventEmitter.removeListener(event, listener) 移除指定事件的某个监听 器，listener 必须是该事件已经注册过的监听器。</li> <li>EventEmitter.removeAllListeners([event]) 移除所有事件的所有监听器， 如果指定 event，则移除指定事件的所有监听器。</li> <li>emitter.eventNames()：返回当前 EventEmitter对象注册的事件字符串数组；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> events <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">events<span class="token punctuation">.</span>EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'someEvent'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'listener1'</span><span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'someEvent'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span> arg2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'listener2'</span><span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'someEvent'</span><span class="token punctuation">,</span> <span class="token string">'byvoid'</span><span class="token punctuation">,</span> <span class="token number">1991</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="文件系统-fs"><a href="#文件系统-fs" class="header-anchor">#</a> 文件系统 fs</h2> <p>fs 模块是文件操作的封装，它提供了文件的读取、写入、更名、删除、遍历目录</p> <ul><li><p>fs.readFile(path[, options], callback)：读取文件的内容；</p></li> <li><p>fs.writeFile(file, data[, options], callback)：在文件中写入内容；</p></li> <li><p>fs.open() 方法用于分配新的文件描述符。</p></li> <li><p>fs.mkdirSync()创建一个新文件夹：</p></li> <li><p>fs.readdir(path[, options], callback)  :读取目录的内容。</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果uploadDir目录不存在就创建目录</span>
<span class="token comment">// existsSync 如果路径存在则返回 true，否则返回 false。</span>
<span class="token comment">// mkdirSync 同步地创建目录。 返回 undefined 或创建的第一个目录路径（如果 recursive 为 true）</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>uploadDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>uploadDir<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="stream-流"><a href="#stream-流" class="header-anchor">#</a> Stream 流</h2> <p>Node.js中有四种基本流类型：</p> <ul><li>Writable：可以向其写入数据的流（例如 fs.createWriteStream()）。</li> <li>Readable：可以从中读取数据的流（例如 fs.createReadStream()）。</li> <li>Duplex：同时为Readable和Writable（例如 net.Socket）。</li> <li>Transform：Duplex可以在写入和读取数据时修改或转换数据的流（例如zlib.createDeflate()）。</li></ul> <p>栗子：</p> <h3 id="readable的使用"><a href="#readable的使用" class="header-anchor">#</a> Readable的使用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//创建文件的Readable</span>
 <span class="token keyword">const</span> read <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./foo.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 事件监听</span>
<span class="token comment">//监听读取到的数据</span>
read<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
read<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">文件被打开</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
read<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件读取结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
read<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件被关闭'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><h3 id="writable的使用"><a href="#writable的使用" class="header-anchor">#</a> Writable的使用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> writer <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">&quot;./foo.txt&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    <span class="token literal-property property">flags</span><span class="token operator">:</span><span class="token string">&quot;a+&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
wrriter<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">&quot;你好啊&quot;</span><span class="token punctuation">,</span><span class="token parameter">err</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;写入完毕&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="pipe-将读取到的输入流放入输出流中"><a href="#pipe-将读取到的输入流放入输出流中" class="header-anchor">#</a> pipe 将读取到的输入流放入输出流中</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> reader <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./foo.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> writer <span class="token operator">=</span> <span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'./bar.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="http"><a href="#http" class="header-anchor">#</a> http</h2> <p>栗子</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">http<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'&lt;h1&gt;Node.js&lt;/h1&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'也可以是数据'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务启动，端口号9000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="express"><a href="#express" class="header-anchor">#</a> express</h1> <h2 id="express-安装"><a href="#express-安装" class="header-anchor">#</a> express  安装</h2> <div class="language-js extra-class"><pre class="language-js"><code>安装脚手架
npm install <span class="token operator">-</span>g express<span class="token operator">-</span>generator
创建项目
express express<span class="token operator">-</span>demo
安装依赖
npm install
启动项目
node bin<span class="token operator">/</span>www
</code></pre></div><h2 id="express-改造项目"><a href="#express-改造项目" class="header-anchor">#</a> express 改造项目</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//改造项目启动</span>
<span class="token comment">// module.exports = app;</span>
<span class="token keyword">const</span> port<span class="token operator">=</span><span class="token number">8001</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;服务已启动，端口号为&quot;</span><span class="token operator">+</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><h2 id="中间件"><a href="#中间件" class="header-anchor">#</a> 中间件</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//对网络请求的数据处理，express有对应的自带中间件处理 ,例如</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">extended</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//文件上传中间件</span>
multer
</code></pre></div><h2 id="路由"><a href="#路由" class="header-anchor">#</a> 路由</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//  routers/user.js</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>currentUser<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../controllers/UsersController&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  当前用户</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/currentUser'</span><span class="token punctuation">,</span> currentUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// app挂载</span>
<span class="token keyword">var</span> usersRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/movies'</span><span class="token punctuation">,</span> usersRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="解析请求参数"><a href="#解析请求参数" class="header-anchor">#</a> 解析请求参数</h2> <ul><li>方式一：通过get请求中的URL的params；  请求地址：http://localhost:8000/login/abc/why</li> <li>方式二：通过get请求中的URL的query；  请求地址：http://localhost:8000/login?username=why&amp;password=123</li> <li>方式三：通过post请求中的body的json格式（中间件中已经使用过）；</li> <li>方式四：通过post请求中的body的x-www-form-urlencoded格式（中间件使用过）；</li> <li>方式五：通过post请求中的form-data格式（中间件中使用过）；</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
</code></pre></div><h2 id="静态资源服务器"><a href="#静态资源服务器" class="header-anchor">#</a> 静态资源服务器</h2> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;/public&quot;</span><span class="token punctuation">,</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h1 id="mongodb"><a href="#mongodb" class="header-anchor">#</a> Mongodb</h1> <h2 id="mongodb-2"><a href="#mongodb-2" class="header-anchor">#</a> Mongodb</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//查询</span>
db<span class="token punctuation">.</span>sub<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//插入</span>
<span class="token comment">//db.sub.insert({_id:&quot;0323&quot;,code:&quot;gfgg&quot; ,name:&quot;gj&quot;, gender:1});</span>
<span class="token comment">//插入</span>
<span class="token comment">//db.sub.insert({_id:&quot;0323&quot; ,name:&quot;gj&quot;, gender:1});</span>
</code></pre></div><h3 id="比较运算符"><a href="#比较运算符" class="header-anchor">#</a> 比较运算符</h3> <div class="language-js extra-class"><pre class="language-js"><code>等于： 默认是等于判断， 没有运算符
小于：$lt （less than）
小于于等于：$lte （less than equal）
大于：$gt （greater than）
大于等于：$gte
不等于：$ne
格式：db<span class="token punctuation">.</span>集合名称<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">$gte</span><span class="token operator">:</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code>UsersModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">$lte</span><span class="token operator">:</span><span class="token number">45</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="mongooes插件"><a href="#mongooes插件" class="header-anchor">#</a> mongooes插件</h2> <p>安装  npm install mongoose</p> <h3 id="连接数据库"><a href="#连接数据库" class="header-anchor">#</a> 连接数据库</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 导入 mongoose 模块</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mongoose<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'strictQuery'</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置默认 mongoose 连接</span>
<span class="token keyword">const</span> mongoDB <span class="token operator">=</span> <span class="token string">'mongodb://127.0.0.1:27017/moviesApp'</span><span class="token punctuation">;</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>mongoDB<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;movieApp数据库链接成功&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;movieApp数据库链接失败&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="定义映射-schema"><a href="#定义映射-schema" class="header-anchor">#</a> 定义映射 schema</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Schema<span class="token punctuation">,</span> model<span class="token punctuation">,</span> SchemaType <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 定义验证函数</span>
<span class="token keyword">function</span> <span class="token function">Int8</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mongoose<span class="token punctuation">.</span><span class="token function">SchemaType</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token string">'Int8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Int8</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>mongoose<span class="token punctuation">.</span><span class="token class-name">SchemaType</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Int8</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">cast</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> _val <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>_val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>SchemaType<span class="token punctuation">.</span>CastError</span><span class="token punctuation">(</span><span class="token string">&quot;Int8&quot;</span><span class="token punctuation">,</span><span class="token string">'Int8: '</span> <span class="token operator">+</span> val <span class="token operator">+</span> <span class="token string">' is not a number'</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _val <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>_val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_val <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token number">0x80</span> <span class="token operator">||</span> _val <span class="token operator">&gt;</span> <span class="token number">0x7f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>SchemaType<span class="token punctuation">.</span>CastError</span><span class="token punctuation">(</span>
            <span class="token string">'Int8: '</span> <span class="token operator">+</span> val <span class="token operator">+</span> <span class="token string">' is outside of the range of valid 8-bit ints'</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> _val<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 将相应的属性添加到 mongoose.Schema.Types</span>
mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>Int8 <span class="token operator">=</span> Int8<span class="token punctuation">;</span>

<span class="token comment">// 映射数据模型的所有字段</span>
<span class="token keyword">const</span> UsersSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
        <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">password</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token literal-property property">order</span><span class="token operator">:</span> Array<span class="token punctuation">,</span>
        <span class="token literal-property property">age</span><span class="token operator">:</span> Int8<span class="token punctuation">,</span><span class="token comment">//使用自定义验证类型</span>
        <span class="token literal-property property">img</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token literal-property property">creatDate</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Date<span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token operator">:</span> Date<span class="token punctuation">.</span>now <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">birthday</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Date<span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2020-10-10 08:00:00'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">phone</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
            <span class="token literal-property property">validate</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">//自定义验证器</span>
                <span class="token function-variable function">validator</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\d{3}-\d{3}-\d{4}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'{VALUE} is not a valid phone number!'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'User phone number required'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">versionKey</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token comment">//不开启版本号</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//  模型名称 , 映射, 表名</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'UsersModel'</span><span class="token punctuation">,</span> UsersSchema<span class="token punctuation">,</span> <span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="查询find"><a href="#查询find" class="header-anchor">#</a> 查询find</h3> <ul><li>Model.find(conditions, [projection], [options], [callback])</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//查询成绩大于60以上的数据</span>
UsersModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">grades</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">$gte</span><span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span>docs</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
         console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>docs<span class="token punctuation">)</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="根据id查询findbyid"><a href="#根据id查询findbyid" class="header-anchor">#</a> 根据id查询findById</h3> <ul><li>Model.findById(id, [projection], [options], [callback])</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> UsersModel<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token string">&quot;6426b1772b18beace7139703&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="查询第一个"><a href="#查询第一个" class="header-anchor">#</a> 查询第一个</h3> <ul><li>Model.findOne([conditions], [projection], [options], [callback])</li></ul> <h3 id="模糊查询"><a href="#模糊查询" class="header-anchor">#</a> 模糊查询</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> regexp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token string">'i'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 正则模糊匹配</span>
<span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> UsersModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">username</span><span class="token operator">:</span> regexp <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> UsersModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">username</span><span class="token operator">:</span><span class="token string">'lisi'</span><span class="token punctuation">,</span><span class="token literal-property property">age</span><span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

另一种
<span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> UsersModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">username</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">$regex</span><span class="token operator">:</span><span class="token string">'s'</span><span class="token punctuation">,</span><span class="token literal-property property">$options</span><span class="token operator">:</span><span class="token string">'$i'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="条件查询"><a href="#条件查询" class="header-anchor">#</a> 条件查询</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> UsersModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">score</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token literal-property property">$lte</span><span class="token operator">:</span>tscore<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>或者UsersModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'score'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


⼩于：$lt （less than）
⼩于等于：$lte （less than equal）
⼤于：$gt （greater than）
⼤于等于：$gte
不等于：$ne
</code></pre></div><h3 id="关联查询populate"><a href="#关联查询populate" class="header-anchor">#</a> 关联查询populate</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string-property property">&quot;movies&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
        <span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token string">'MoviesModel'</span>
      <span class="token punctuation">}</span>

<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> OperasModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span><span class="token string">'movies'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">select</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">,</span><span class="token string">'movieType'</span><span class="token punctuation">,</span><span class="token string">'score'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
     <span class="token literal-property property">populate</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span><span class="token string">'movieType'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="自定义查询-where"><a href="#自定义查询-where" class="header-anchor">#</a> 自定义查询 $where</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//条件内部作用域貌似不一样，无法使用外部变量</span>
<span class="token keyword">await</span> UsersModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token function-variable function">$where</span><span class="token operator">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token operator">==</span><span class="token keyword">null</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
       <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="更新一个数据"><a href="#更新一个数据" class="header-anchor">#</a> 更新一个数据</h3> <ul><li>Model.updateOne(conditions, doc, [options], [callback])</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>UsersModel<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="更新全部"><a href="#更新全部" class="header-anchor">#</a> 更新全部</h3> <ul><li>await UsersModel.updateOne({ _id: id }, { password });</li></ul> <h3 id="更改数据-update"><a href="#更改数据-update" class="header-anchor">#</a> 更改数据 update</h3> <ul><li>Model.update(conditions, doc, [options], [callback])</li> <li>options
<ul><li>runValidators  ，更新验证 器   4.0   默认是关闭的</li> <li>multi  是否全部更新</li></ul></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">runValidators</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token literal-property property">multi</span><span class="token operator">:</span><span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
UsersModel<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> password <span class="token punctuation">}</span><span class="token punctuation">,</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="增加数据"><a href="#增加数据" class="header-anchor">#</a> 增加数据</h3> <ul><li>Model.create(doc(s), [callback])  操作模型</li> <li>Model.prototype.save([options], [options.safe], [options.validateBeforeSave], [fn])  操作文档</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>UsersModel<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

UsersModel<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

OrdersModel<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="删除第一个-deleteone"><a href="#删除第一个-deleteone" class="header-anchor">#</a> 删除第一个 deleteOne</h3> <ul><li>Model.deleteOne(conditions，[options] )</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> UsersModel<span class="token punctuation">.</span><span class="token function">deleteOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="删除所有满足条件的"><a href="#删除所有满足条件的" class="header-anchor">#</a> 删除所有满足条件的</h3> <ul><li>Model.deleteMany(conditions，[options] )</li></ul> <h2 id="代码片段"><a href="#代码片段" class="header-anchor">#</a> 代码片段</h2> <h3 id="将数组字段内的数值数据更换成对象id"><a href="#将数组字段内的数值数据更换成对象id" class="header-anchor">#</a> 将数组字段内的数值数据更换成对象id</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>思路：先将数据转行成与对象id等长的字符串，再将字符串转换成对象id
上代码<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>

Schema模型
 <span class="token literal-property property">movieType</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token comment">// type: String,// 先将字段类型设置为字符串，便于转换成对象id长度的字符</span>
                <span class="token literal-property property">type</span><span class="token operator">:</span>  Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
                <span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token string">'TestModel'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code> <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;接口未开通&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 数据库查询数据的方法,find方法可以传参</span>
            <span class="token keyword">let</span> rtn <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'成功'</span><span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> MoviesModel<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">movieType</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            users<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">items</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> movieTypeArr <span class="token operator">=</span> items<span class="token punctuation">.</span>movieType<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>movieTypeArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> tempArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> movieTypeArr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">let</span> element <span class="token operator">=</span> movieTypeArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">?</span>movieTypeArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">:</span>movieTypeArr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">==</span> <span class="token string">'number'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> element <span class="token operator">==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            element <span class="token operator">=</span> <span class="token function">formatSchemaObject</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// log(element);</span>
                            <span class="token comment">// let t = new Schema.Types.ObjectId('' + element);</span>
                            tempArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            element <span class="token operator">=</span> <span class="token function">formatSchemaObject</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            tempArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tempArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">let</span> _id <span class="token operator">=</span> items<span class="token punctuation">.</span>_id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">await</span> MoviesModel<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">movieType</span><span class="token operator">:</span> tempArr <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rtn<span class="token punctuation">.</span>data <span class="token operator">=</span> users<span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>rtn<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

</code></pre></div><h1 id="文件上传"><a href="#文件上传" class="header-anchor">#</a> 文件上传</h1> <h2 id="配置路由"><a href="#配置路由" class="header-anchor">#</a> 配置路由</h2> <p>app.js 引入路由</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> filesRouter<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/files'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/files'</span><span class="token punctuation">,</span> filesRouter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>routes</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//配置路由</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>fileUp<span class="token punctuation">,</span>updateUserHeadImg<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../controllers/FilesController'</span><span class="token punctuation">)</span>
<span class="token comment">//1. 文件上传，请求方式一定是post</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/fileUp'</span><span class="token punctuation">,</span>fileUp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 确认修改</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/updateUserHeadImg'</span><span class="token punctuation">,</span>updateUserHeadImg<span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>

</code></pre></div><h2 id="filescontroller-js"><a href="#filescontroller-js" class="header-anchor">#</a> FilesController.js</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//写文件上传的逻辑以及返回</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> uploadFiles<span class="token punctuation">,</span>moveFiles <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/filesUtil'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Utils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> UsersModel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/UsersModel'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">FilesController</span> <span class="token punctuation">{</span>
    <span class="token function">fileUp</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> uploading <span class="token operator">=</span> <span class="token function">uploadFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">uploading</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                    <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'文件上传失败'</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">//文件上传成功</span>
                <span class="token comment">//req.files就是文件上传成功后的一些相关的文件信息</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>files<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>files<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'文件上传成功'</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/temp/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>filename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'文件上传失败'</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//后端修改用户信息的接口</span>
    <span class="token keyword">async</span> <span class="token function">updateUserHeadImg</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> bearerToken <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bearerToken<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bearerToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//解码token</span>
            <span class="token keyword">const</span> decode<span class="token operator">=</span>Utils<span class="token punctuation">.</span><span class="token function">verifyToken</span><span class="token punctuation">(</span>bearerToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span>filename<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body
            <span class="token comment">// </span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> fromPath<span class="token operator">=</span><span class="token string">'public/temp/'</span>
            <span class="token keyword">const</span> toPath<span class="token operator">=</span><span class="token string">'public/images/'</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//将图片移动到images文件夹下</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">moveFiles</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        fromPath<span class="token punctuation">,</span>
                        toPath<span class="token punctuation">,</span>
                        filename
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token comment">// 修改用户信息</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>toPath<span class="token operator">+</span>filename <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> UsersModel<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> decode<span class="token punctuation">.</span>_id <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">img</span><span class="token operator">:</span>filename <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'修改成功'</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'头像修改失败'</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'token失效'</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilesController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="工具库"><a href="#工具库" class="header-anchor">#</a> 工具库</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> multer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 上传文件</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>uploadFiles <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> dir <span class="token operator">=</span> <span class="token string">&quot;./public/temp&quot;</span><span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">10000</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. 对参数进行解构并设置默认值</span>
    <span class="token comment">// 2. 设置 multer 的参数，配置 diskStorage，来控制文件存储的位置以及文件名字等</span>
    <span class="token keyword">const</span> storage <span class="token operator">=</span> multer<span class="token punctuation">.</span><span class="token function">diskStorage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 2.1 确定图片存储的位置</span>
        <span class="token function-variable function">destination</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 当 dir 所对应目录不存在时，则自动创建该文件</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 2.2 确定图片存储时的名字。（注意：如果使用原名，可能会造成再次上传同一张图片的时候的冲突）</span>
        <span class="token function-variable function">filename</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> file<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> changedName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>originalname<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> changedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 配置图片限制</span>
    <span class="token keyword">const</span> limits <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment">// 限制文件大小</span>
        <span class="token literal-property property">fileSize</span><span class="token operator">:</span> <span class="token number">1024</span> <span class="token operator">*</span> size<span class="token punctuation">,</span>
        <span class="token comment">// 限制文件数量</span>
        <span class="token literal-property property">files</span><span class="token operator">:</span> <span class="token number">10</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 4.生成的专门处理上传的一个工具，可以传入 storage、limits 等配置</span>
    <span class="token keyword">const</span> upload <span class="token operator">=</span> <span class="token function">multer</span><span class="token punctuation">(</span><span class="token punctuation">{</span> storage<span class="token punctuation">,</span> limits <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 5. 返回多文件上传的设置信息（同样可用于单文件上传）</span>
    <span class="token keyword">return</span> upload<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 移动文件</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">moveFiles</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> fromPath<span class="token punctuation">,</span> toPath<span class="token punctuation">,</span> filename <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'========== 文件移动失败: filename 文件名不能为空 =========='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 要移动的文件的原路径</span>
    <span class="token keyword">const</span> sourceFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>fromPath<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 判断源文件是否存在</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'========== 文件移动失败：'</span> <span class="token operator">+</span> sourceFile <span class="token operator">+</span> <span class="token string">' 该文件不存在。=========='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 判断文件要移动的新路径是否存在，如果不存在，则创建</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">accessSync</span><span class="token punctuation">(</span>toPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span>toPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 文件移动后的新路径</span>
    <span class="token keyword">const</span> newFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>toPath<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">renameSync</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">,</span> newFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">newPath</span><span class="token operator">:</span> newFile <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="前端网络请求封装"><a href="#前端网络请求封装" class="header-anchor">#</a> 前端网络请求封装</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 默认异步  jquery  Promise</span>
<span class="token keyword">export</span>  <span class="token keyword">function</span> <span class="token function">$cn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> async <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> dataType <span class="token operator">=</span> <span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span> timeout <span class="token operator">=</span> <span class="token number">3000</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    url <span class="token operator">=</span> <span class="token constant">URL_NODE_SERVER</span> <span class="token operator">+</span> url<span class="token punctuation">;</span>
    <span class="token keyword">const</span> token<span class="token operator">=</span><span class="token function">getLocal</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data<span class="token operator">=</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//  contentType:&quot;application/json&quot;的时候必须串json字符串</span>
    <span class="token keyword">const</span> exclude<span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/login|\/register</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token operator">==</span><span class="token string">&quot;&quot;</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span>exclude<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">code</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">901</span><span class="token punctuation">,</span><span class="token literal-property property">msg</span><span class="token operator">:</span><span class="token string">&quot;没有token&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> method<span class="token punctuation">,</span><span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>data<span class="token punctuation">,</span>dataType<span class="token punctuation">,</span>async<span class="token punctuation">,</span>timeout<span class="token punctuation">,</span> <span class="token comment">// 超时设置 单位毫秒</span>
            <span class="token literal-property property">contentType</span><span class="token operator">:</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">,</span> <span class="token comment">//&quot;application/json&quot;</span>
            <span class="token literal-property property">headers</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token comment">//将token每次请求的时候放在请求头中，然后需要在token之前拼接'Bearer '</span>
                <span class="token literal-property property">Authorization</span><span class="token operator">:</span><span class="token string">'Bearer '</span> <span class="token operator">+</span> token  
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>img<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>img<span class="token operator">=</span><span class="token constant">URL_NODE_SERVER</span><span class="token operator">+</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span>img<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
               <span class="token punctuation">}</span>
               
                <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 用于文件传输  头像</span>
<span class="token keyword">export</span>  <span class="token keyword">function</span> <span class="token function">$upFile</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span>  url <span class="token operator">=</span> <span class="token constant">URL_NODE_SERVER</span> <span class="token operator">+</span> <span class="token string">'/files/fileUp'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> token<span class="token operator">=</span><span class="token function">getLocal</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> exclude<span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/login|\/register</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token operator">==</span><span class="token string">&quot;&quot;</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span>exclude<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token literal-property property">code</span><span class="token operator">:</span><span class="token operator">-</span><span class="token number">901</span><span class="token punctuation">,</span><span class="token literal-property property">msg</span><span class="token operator">:</span><span class="token string">&quot;没有token&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>  <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        $<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span><span class="token literal-property property">url</span><span class="token operator">:</span> url<span class="token punctuation">,</span>data<span class="token punctuation">,</span> <span class="token comment">// 超时设置 单位毫秒</span>
           <span class="token comment">//禁止jqueryAjax对传输的数据格式进行内部处理</span>
        <span class="token literal-property property">contentType</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">processData</span><span class="token operator">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token literal-property property">headers</span><span class="token operator">:</span><span class="token punctuation">{</span>
                <span class="token comment">//将token每次请求的时候放在请求头中，然后需要在token之前拼接'Bearer '</span>
                <span class="token literal-property property">Authorization</span><span class="token operator">:</span><span class="token string">'Bearer '</span> <span class="token operator">+</span> token  
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">success</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token constant">URL_NODE_SERVER</span><span class="token operator">+</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">error</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="前端使用栗子"><a href="#前端使用栗子" class="header-anchor">#</a> 前端使用栗子</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// 确认修改</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#changeImg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token string">&quot;请先选择头像&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> filename <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#headImg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">&quot;background-image&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filename <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>filename<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        filename <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&quot;)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> option <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token string">&quot;/files/updateUserHeadImg&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                filename
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">$cn</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 发送文件数据</span>
    <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#fileImg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// console.dir(this.files[0]);</span>
        <span class="token comment">// 1.拿文件数据</span>
        <span class="token keyword">const</span> fileInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token comment">// 2.通 FormData 构造函数对文件数据进行格式转换，转换成二进制流</span>
        <span class="token keyword">const</span> fd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fd<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> fileInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">$upFile</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">&quot;#headImg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">&quot;background-image&quot;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">url(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>res<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="md5加密"><a href="#md5加密" class="header-anchor">#</a> MD5加密</h2> <ul><li>基于crypto， nodejs提供的一个内置模块，用于数据加密</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
     * 对数据进行加密   密码加密使用
     * @param {Sting} str 
     * @param {Sting} secret 
     * @returns 
     */</span>
<span class="token function">getCrypto</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> secret <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> md5 <span class="token operator">=</span> Crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span>
    <span class="token comment">// return md5.update('需要加密的字符串'+'秘钥').digest('hex')</span>
    <span class="token keyword">return</span> md5<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>str <span class="token operator">+</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>生成随机秘钥：https://www.avast.com/zh-cn/random-password-generator#mac</p> <p>用户的话可以用用户code做密钥，保证对一个用户来说不变的那个值，code要变就不行</p> <h1 id="jwt身份认证流程"><a href="#jwt身份认证流程" class="header-anchor">#</a> JWT身份认证流程</h1> <h2 id="jwt本身也是一种规范"><a href="#jwt本身也是一种规范" class="header-anchor">#</a> JWT本身也是一种规范，</h2> <ol><li>前端进行登录操作，将登录的信息发送给后端，后端就会比对信息判断是否登录成功</li> <li>如果登录成功，后端会生成一个字符串token，后端会将token返回给前端</li> <li>前端拿到登录成功的消息，会在跳转页面之前将token保存到本地储存</li> <li>前端在进入某些需要进行登录验证的页面时，会首先去验证本地储存中是否包含token，如果没有，就会跳转到登录页面</li> <li>同时需要后端对token进行验证，验证是否超期或者是登录失效，如果后端验证失败，就会返回结果401给前端，</li> <li>前端拿到401之后就会进行提示，提示登录失效请重新登录，跳转登录页面</li> <li>某些请求也需要对登录信息进行身份认证。比如：订单，个人中心….，认证不通过也会返回401</li></ol> <h2 id="后端生产token"><a href="#后端生产token" class="header-anchor">#</a> 后端生产token</h2> <ol><li>下载插件 jsonwebtoken</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>npm install jsonwebtoken
</code></pre></div><ol start="2"><li>生成token</li></ol> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">/**
     *@Desc: 获取密钥
     *@Author: Wanglei
     *@Date: 2023-04-07 15:10:45
     *@param {Sting} type  类型
     */</span>
    <span class="token function">getSecret</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token string">'token'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">'wCQZSgytEhB66Meu'</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     *@Desc: 生成token
     *@Author: Wanglei
     *@Date: 2023-04-07 15:10:45
     *@param {String} id 用户表_id
     *@param {String} secret 密钥
     *@param {Number} timeLimit 时效 秒
     */</span>
    <span class="token function">getToken</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>secret<span class="token operator">=</span><span class="token string">&quot;&quot;</span> <span class="token punctuation">,</span>timeLimit <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         secret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//生成token</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> Jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>
            <span class="token punctuation">{</span> <span class="token literal-property property">_id</span><span class="token operator">:</span> id<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">//用于保存用户的相关信息</span>
            secret<span class="token punctuation">,</span> <span class="token comment">//秘钥，不能公布出去</span>
            <span class="token punctuation">{</span> <span class="token literal-property property">expiresIn</span><span class="token operator">:</span> timeLimit <span class="token punctuation">}</span> <span class="token comment">//设置token的有效期,时间以秒为单位</span>
        <span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> token
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     *@Desc: 解析token
     *@Author: Wanglei
     *@Date: 2023-04-07 15:10:45
     *@param {String} bearerToken 前端传递的 Authorization
     *@param {String} secret 密钥
     */</span>
    <span class="token function">verifyToken</span><span class="token punctuation">(</span><span class="token parameter">bearerToken</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span>  secret <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取到真实的token</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> bearerToken<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">//解码token</span>
        <span class="token keyword">const</span> decode <span class="token operator">=</span> Jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>
            token<span class="token punctuation">,</span>
            secret <span class="token comment">//秘钥</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> decode
    <span class="token punctuation">}</span>
</code></pre></div><p>3 挂载到app</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>expressjwt<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-jwt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jwtAuth <span class="token operator">=</span> <span class="token function">expressjwt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    secret<span class="token punctuation">,</span> <span class="token comment">//秘钥 与登录时的秘钥一致</span>
    <span class="token literal-property property">algorithms</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'HS256'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//jwt的验证算法</span>
    <span class="token comment">//前端如果没有发送token过来，也会直接返回401的状态</span>
    <span class="token comment">//false代表验证是否包含token</span>
    <span class="token literal-property property">credentialsRequired</span><span class="token operator">:</span><span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unless</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">//用于配置不需要身份认证的接口</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/login</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/reg</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/temp</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/images</span><span class="token regex-delimiter">/</span></span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>jwtAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="使用公钥和私钥作为密钥"><a href="#使用公钥和私钥作为密钥" class="header-anchor">#</a> 使用公钥和私钥作为密钥：</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 读取公钥和私钥文件</span>
<span class="token keyword">const</span> publicKey <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'public.pem'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> privateKey <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'private.pem'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 签发 JWT</span>
<span class="token keyword">function</span> <span class="token function">signToken</span><span class="token punctuation">(</span><span class="token parameter">payload<span class="token punctuation">,</span> expiresIn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> privateKey<span class="token punctuation">,</span> <span class="token punctuation">{</span> expiresIn <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 验证 JWT</span>
<span class="token keyword">function</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span><span class="token parameter">token</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Invalid token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>/使用示例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">userId</span><span class="token operator">:</span> <span class="token number">123</span><span class="token punctuation">,</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'john.doe'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 签发 JWT</span>
<span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">signToken</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token string">'1h'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Token:'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 验证 JWT</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> decodedToken <span class="token operator">=</span> <span class="token function">verifyToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Decoded Token:'</span><span class="token punctuation">,</span> decodedToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h1 id="end"><a href="#end" class="header-anchor">#</a> end</h1></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog-web/React/react.html" class="prev">
        React
      </a></span> <span class="next"><a href="/blog-web/TS/ts.html">
        ts
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog-web/assets/js/app.eabe3d57.js" defer></script><script src="/blog-web/assets/js/2.7f8e9262.js" defer></script><script src="/blog-web/assets/js/1.94089482.js" defer></script><script src="/blog-web/assets/js/24.92e24571.js" defer></script>
  </body>
</html>
